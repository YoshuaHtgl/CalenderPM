<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>PM Year Plan</title>
<style>
body{font-family:Arial;background:#eef2ff;margin:0;padding:20px;}
h2{color:#1d4ed8;margin-bottom:10px;}
table{width:100%;border-collapse:collapse;margin-top:10px;background:white;}
th,td{border:1px solid #cfcfcf;padding:6px;text-align:center;}
th{background:#1d4ed8;color:white;}
.cell{cursor:pointer;transition:0.2s;}
.cell:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(0,0,0,0.2);}
.overdue{background:#ffb3b3;}
.soon{background:#ffe89c;}
.normal{background:#baffc0;}
#status{margin-top:10px;color:#64748b;font-size:0.9rem;}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;}
.modal.active{display:flex;}
.modal-content{background:white;padding:20px;border-radius:12px;width:310px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);}
.modal-content h3{margin-top:0;color:#1d4ed8;font-size:17px;}
.modal-content input, select{
  width:100%;padding:7px;margin:6px 0 10px;border-radius:6px;border:1px solid #ccc;
}
button{padding:8px 12px;border:none;border-radius:6px;margin-left:6px;cursor:pointer;}
.save{background:#1d4ed8;color:white;font-weight:bold;}
.cancel{background:#999;color:white;}
</style>
</head>
<body>

<h2>üìÖ Preventive Maintenance ‚Äî Year View</h2>
<div id="status">‚è≥ Loading...</div>
<div id="container"></div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>

    <label>Start Date</label>
    <input type="date" id="inputStart">

    <label>Finish Date</label>
    <input type="date" id="inputFinish">

    <label>Status</label>
    <select id="inputStatus">
      <option>Planning</option>
      <option>On Progress</option>
      <option>Selesai</option>
    </select>

    <div style="text-align:right;">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="save" onclick="saveUpdate()">Save</button>
    </div>
  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzLzrLPKgy-z0Ks3PXO6sYw7_6E1C6U4B9_G3vbd2H0G-SR1iFWPAci087uYU2h1XwgRw/exec?action=update&month=JAN&row=2&status=TES_DARI_URL&start=2025-02-10&finish=2025-02-12";
const API_URL = WEBAPP_URL + "?action=pmYear";

let pmData=[];
let selectedMonth, selectedRowIndex;

async function loadPM(){
  document.getElementById("status").textContent="‚è≥ Loading...";
  
  try{
    const res = await fetch(API_URL);
    pmData = await res.json();
    renderTable();
    document.getElementById("status").textContent="‚úî Data Loaded";
  }catch(err){
    document.getElementById("status").textContent="‚ùå ERROR LOADING DATA ‚Äî Check Internet or WebApp URL";
    console.error(err);
    alert("‚ùå Gagal memuat data!\n\nError: " + err.message);
  }
}

function getColor(date){
  if(!date) return "";
  const diff = (new Date(date) - new Date()) / 86400000;
  return diff < 0 ? "overdue" : diff <= 7 ? "soon" : "normal";
}

function renderTable(){
  const months=["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGT","SEP","OKT","NOV","DES"];
  let html=`<table><tr><th>Plant</th><th>Last PM</th><th>Frekuensi</th><th>Next PM</th>`;
  html+=months.map(m=>`<th>${m}</th>`).join("") + "</tr>";

  pmData.forEach((row,i)=>{
    html+=`<tr><td><b>${row.plant}</b></td>
      <td>${row.lastPM||"-"}</td><td>${row.freq||"-"}</td><td>${row.nextPM||"-"}</td>`;
    row.schedule.forEach(c=>{
      html+=`<td class="cell ${getColor(c.start)}"
        onclick="openModal('${c.month}',${i})">
        ${c.start||"-"}<br><small>${c.status||""}</small></td>`;
    });
    html+="</tr>";
  });

  html+="</table>";
  document.getElementById("container").innerHTML = html;
}

function openModal(month,i){
  selectedMonth=month;
  selectedRowIndex=pmData[i].rowIndex;
  const c = pmData[i].schedule.find(x => x.month===month);
  document.getElementById("modalTitle").innerText=`Edit ${pmData[i].plant} ‚Äî ${month}`;
  document.getElementById("inputStart").value=c.start||"";
  document.getElementById("inputFinish").value=c.finish||"";
  document.getElementById("inputStatus").value=c.status||"Planning";
  document.getElementById("editModal").classList.add("active");
}

function closeModal(){
  document.getElementById("editModal").classList.remove("active");
}

// üöÄ SAVE FUNCTION + ERROR HANDLING
async function saveUpdate(){

  const payload = {
    month:selectedMonth,
    row:selectedRowIndex,
    start:document.getElementById("inputStart").value,
    finish:document.getElementById("inputFinish").value,
    status:document.getElementById("inputStatus").value
  };

  // Loading message
  document.getElementById("status").textContent = "‚è≥ Saving... Please wait";

  try{
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 7000); // ‚è± auto cancel 7s

    const res = await fetch(WEBAPP_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload),
      signal:controller.signal
    });

    clearTimeout(timeout);

    if(!res.ok) throw new Error("Server returned status " + res.status);

    let result = await res.json().catch(()=>null);

    if(result?.success){
      alert("‚úÖ Data berhasil disimpan!");
    }else{
      throw new Error(result?.error || "Unknown error from server");
    }

    closeModal();
    loadPM();

  }catch(err){
    console.error(err);
    alert(`‚ùå Gagal menyimpan data!\n\nPenyebab:\n${err.message}\n\nüëâ Cek:\n- Izin WebApp (Deploy ulang)\n- Internet\n- Format WebApp URL`);
    document.getElementById("status").textContent = "‚ö† ERROR SAVING ‚Äî Check connection";
  }
}

loadPM();
</script>
</body>
</html>
