<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>PM Calendar Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #eef2ff;
      color: #0f172a;
    }

    header {
      padding: 16px 24px;
      background: #1d4ed8;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar {
      background:white;
      padding:10px;
      border-bottom:1px solid #d1d5db;
      display:flex;
      gap:10px;
    }

    button{
      background:#1d4ed8;
      color:white;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
    }
    button:hover{
      background:#123baf;
    }

    #yearView table {
      width:100%;
      border-collapse: collapse;
      margin-top:15px;
      background:white;
      border-radius:10px;
      overflow:hidden;
    }
    #yearView th, #yearView td {
      border:1px solid #c7c7c7;
      padding:6px;
      text-align:center;
    }
    #yearView th {
      background:#1d4ed8;
      color:white;
    }

    .event-overdue { background:#ffb3b3!important; }
    .event-due-soon { background:#ffe8a1!important; }
    .event-normal { background:#c8ffd3!important; }
  </style>
</head>
<body>

<header>
  <h2>ðŸ“… PM Calendar Dashboard</h2>
  <div>Live from Google Sheets</div>
</header>

<div class="toolbar">
  <button onclick="generateSchedule()">ðŸ”§ Generate 1 Tahun</button>
  <button onclick="showCalendar()">ðŸ“… Calendar</button>
  <button onclick="showList()">ðŸ“‹ List</button>
  <button onclick="showYear()">ðŸ—“ Year View</button>
</div>

<div id="calendar"></div>

<div class="list-wrapper" style="display:none;padding:10px;background:white;border-radius:10px;margin:10px;">
  <ul id="pmList"></ul>
</div>

<!-- AREA VIEW TAHUN -->
<div id="yearView" style="display:none;padding:15px;"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>

let calendar;
let allPmData = [];

document.addEventListener("DOMContentLoaded", function(){
  const calendarEl = document.getElementById("calendar");

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView:"dayGridMonth",
    height:"auto"
  });

  calendar.render();
  loadPMData();
});

function loadPMData(){
  google.script.run.withSuccessHandler(data=>{
    allPmData=data||[];
    renderCalendar();
    renderList();
  }).getPMData();
}

function generateSchedule(){
  google.script.run.generateFullYear();
  setTimeout(loadPMData,1000);
}

/* ---------- MODE SWITCH ---------- */
function showCalendar(){
  document.getElementById("calendar").style.display="block";
  document.querySelector(".list-wrapper").style.display="none";
  document.getElementById("yearView").style.display="none";
}

function showList(){
  document.getElementById("calendar").style.display="none";
  document.querySelector(".list-wrapper").style.display="block";
  document.getElementById("yearView").style.display="none";
}

function showYear(){
  document.getElementById("calendar").style.display="none";
  document.querySelector(".list-wrapper").style.display="none";
  document.getElementById("yearView").style.display="block";
  renderYearView();
}

/* ---------- YEAR VIEW FEATURE ---------- */
function renderYearView(){
  const months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  let html=`<table><tr><th>PLANT</th>${months.map(m=>`<th>${m}</th>`).join("")}</tr>`;

  allPmData.forEach(row=>{
    html+=`<tr><td><b>${row.plant}</b></td>`;
    row.yearSchedule.forEach(date=>{
      let style=getYearColor(date);
      html+=`<td style="${style}" onclick="alert('${row.plant} â†’ ${date}')">${date||"-"}</td>`;
    });
    html+=`</tr>`;
  });

  html+="</table>";
  document.getElementById("yearView").innerHTML=html;
}

function getYearColor(date){
  if(!date) return "background:#f5f5f5;";
  const diff=(new Date(date)-new Date())/(1000*60*60*24);
  if(diff<0) return "background:#ffb3b3;"; 
  if(diff<=7) return "background:#ffe8a1;"; 
  return "background:#c8ffd3;";
}

/* ---------- CALENDAR EVENTS ---------- */
function renderCalendar(){
  calendar.removeAllEvents();
  allPmData.forEach(item=>{
    item.yearSchedule.forEach(date=>{
      if(date){
        calendar.addEvent({ title:item.plant,start:date, className:[getStatus(date)] });
      }
    });
  });
}

function getStatus(date){
  const diff=(new Date(date)-new Date())/(1000*60*60*24);
  if(diff<0) return "event-overdue";
  if(diff<=7) return "event-due-soon";
  return "event-normal";
}

/* ---------- LIST VIEW ---------- */
function renderList(){
  document.getElementById("pmList").innerHTML=
    allPmData.map(d=>`<li><b>${d.plant}</b> â†’ Next: ${d.nextPM}</li>`).join("");
}

</script>
</body>
</html>
