<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>PM Calendar</title>

<style>

/* ===== BODY ===== */
body{
  font-family: Arial, sans-serif;
  background:#eef2ff;
  margin:0;
  padding-top:20px; /* <<< TIDAK freeze header, jadi kecilkan */
  overflow-x:auto;
}

/* ===== TITLE + BUTTONS (NORMAL, BUKAN STICKY) ===== */
.header {
  width:100%;
  background:#eef2ff;
  padding:15px 20px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:10;
}

.title {
  font-size:22px;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:8px;
}

.toolbar {
  display:flex;
  align-items:center;
  gap:10px;
}

/* ===== BUTTONS ===== */
.btn {
  background:#2563eb;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
  transition:.2s;
  box-shadow:0 2px 5px rgba(0,0,0,0.15);
}

.btn:hover { transform:scale(1.05); }
.btn-green { background:#16a34a; }

/* ===== TABLE ===== */
table{
  border-collapse:collapse;
  width:100%;
  background:white;
}

/* ===== FREEZE ONLY TABLE HEADER ===== */
th,td{
  border:1px solid #ccc;
  padding:6px 8px;
  font-size:13px;
}

th{
  background:#2563eb;
  color:white;
  position:sticky;
  top:0; /* <<< Freeze di atas, tidak kena header lagi */
  z-index:999;
  text-align:center;
}

/* ===== CELL STYLE ===== */
.month-cell{
  text-align:center;
  cursor:pointer;
  font-size:10px;
  font-weight:bold;
  min-width:55px;
  padding:4px;
}

.st-empty{ background:#f3f4f6; color:#6b7280; }
.st-out{ background:#fee2e2; color:#b91c1c; }
.st-progress{ background:#fef3c7; color:#92400e; }
.st-done{ background:#dcfce7; color:#166534; }
.predict-cell{ background:#dbeafe; color:#1e3a8a; border:2px solid #1d4ed8; }

/* ===== MODAL ===== */
#overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
}

#editModal{
  background:white;
  padding:18px;
  width:350px;
  border-radius:10px;
  box-shadow:0 8px 30px rgba(0,0,0,0.25);
}

</style>
</head>

<body>

<div class="header">
  <div class="title">ðŸ“‹ Preventive Maintenance Calendar</div>

  <div class="toolbar">
    <button class="btn" onclick="loadData()">ðŸ”„ Refresh</button>
    <button class="btn btn-green" onclick="window.location.href='https://yoshuahtgl.github.io/form-ReportPM/'">ðŸ“Œ Detail Report</button>
    <button class="btn btn-green" onclick="window.location.href='https://yoshuahtgl.github.io/dasboard_PM/'">ðŸ“Š Dashboard</button>

    <span id="statusText" style="font-size:12px;color:#333;"></span>
  </div>
</div>

<table id="pmTable">
  <thead></thead>
  <tbody></tbody>
</table>


<!-- ==== MODAL ==== -->
<div id="overlay">
  <div id="editModal">
    <h3 id="modalTitle"></h3>
    
    <label>Status</label>
    <select id="statusInput">
      <option value="">(kosong)</option>
      <option value="OUTSTANDING">OUTSTANDING</option>
      <option value="PROGRESS">PROGRESS</option>
      <option value="SELESAI">SELESAI</option>
    </select>

    <label>Start Date</label>
    <input type="date" id="startInput">

    <label>Finish Date</label>
    <input type="date" id="finishInput">

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button onclick="closeModal()" class="btn">Batal</button>
      <button onclick="saveMonth()" class="btn btn-green">Simpan</button>
    </div>
  </div>
</div>


<script>

const apiURL = "https://script.google.com/macros/s/AKfycbwV7YMhqG3EbC2i5jzmF_cL7D137Krs5Jc9VoFAVvtiV3yt-F4gz4byu37TLbVlcM9gxw/exec";
const BASE_COLS = ["NAMA PLANT","LAST PM","FREK","NEXT PM"];
const MONTHS = ["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGT","SEP","OKT","NOV","DES"];

let allData=[], currentRowIndex=null, currentMonth=null;

function formatDate(v){
  if(!v) return "";
  let d=new Date(v);
  return d.toLocaleDateString("id-ID");
}

function loadData(){
  document.getElementById("statusText").innerText="Loading...";
  fetch(apiURL+"?action=get")
  .then(r=>r.json())
  .then(data=>{
      allData=data;
      renderTable();
      document.getElementById("statusText").innerText="âœ” Loaded";
  });
}

function renderTable(){
  const head=document.querySelector("#pmTable thead");
  const body=document.querySelector("#pmTable tbody");
  const nowYear=new Date().getFullYear();

  head.innerHTML=`<tr>
    ${BASE_COLS.map(h=>`<th>${h}</th>`).join("")}
    ${MONTHS.map(m=>`<th>${m}</th>`).join("")}
    <th>Next</th>
  </tr>`;

  body.innerHTML=allData.map((row,i)=>{
    const next=new Date(row["NEXT PM"]||"");
    const nextFuture=next.getFullYear()>nowYear;

    let html=`<tr>
      <td>${row["NAMA PLANT"]}</td>
      <td>${formatDate(row["LAST PM"])}</td>
      <td style="text-align:center">${row["FREK"]||""}</td>
      <td>${formatDate(row["NEXT PM"])}</td>`;

    MONTHS.forEach((m,idx)=>{
      const isPredicted=next.getFullYear()==nowYear && next.getMonth()==idx && !row[`${m}_STATUS`];
      html+=`<td class="month-cell ${isPredicted?"predict-cell":getClass(row[`${m}_STATUS`])}" onclick="openModal(${i},'${m}')">${row[`${m}_STATUS`]||"-"}</td>`;
    });

    html+=`<td class="${nextFuture?"predict-cell":""}">${nextFuture?formatDate(row["NEXT PM"]):""}</td></tr>`;

    return html;
  }).join("");
}

function getClass(s){
  if(!s) return "st-empty";
  s=s.toUpperCase();
  if(s.includes("OUT")) return "st-out";
  if(s.includes("PROGRESS")) return "st-progress";
  if(s.includes("SELESAI")) return "st-done";
  return "st-empty";
}

function openModal(i,m){
  currentRowIndex=i;
  currentMonth=m;
  document.getElementById("modalTitle").innerText=`${m} - ${allData[i]["NAMA PLANT"]}`;
  document.getElementById("overlay").style.display="flex";
}

function closeModal(){
  document.getElementById("overlay").style.display="none";
}

function saveMonth(){
  alert("Saving logic tetap sama âœ¨");
  closeModal();
}

loadData();
</script>

</body>
</html>
